---
title: "Project"
subtitle: "Scoring, M2 Data Science for Social Sciences"
author: "Th√©o Druilhe, Pierre Larose, Nathan Pizzetta, Sigurd/Zizigur Saue"
format: 
  html:
    theme: 
       light: cerulean
    code-fold: true
    warning: false
    message: false
    toc: true
    toc-depth: 3
    embed-resources: true
    self-contained: true
    code-tools:
      source: true
execute:
  cache: true
editor: 
    markdown: 
       wrap: sentence
---


```{r, eval=FALSE}
library(tidyverse)
library(dbplyr)
library(RPostgres)
# First create two environment variables to connect wrds
# in a terminal: touch $HOME/.Renviron
# inside the .Renviron file
# wrds_user = your_user
# wrds_password = your_password

wrds <- dbConnect(
    Postgres(),
    host = "wrds-pgdata.wharton.upenn.edu",
    dbname = "wrds",
    port = 9737,
    sslmode = "require",
    user = Sys.getenv("wrds_user"),
    password = Sys.getenv("wrds_password")
)

compustat_list <- dbListObjects(wrds, Id(schema = "comp"))

# Use dplyr verbs with a remote database table
# https://dbplyr.tidyverse.org/reference/tbl.src_dbi.html
funda_db <- tbl(wrds, in_schema("comp", "funda"))
funda_db %>%
  filter(grepl('APPLE INC', conm)) %>%
  select(gvkey, fyear, conm, at, wcap, re, ebit, lt, sale) %>%
  mutate(WCTA = wcap / at,
         RETA = re / at,
         EBTA = ebit / at,
         TLTA  = lt / at, # as a proxy for ME/TL
         SLTA = sale / at)
```

# Building our dataset

## Building Y

```{r}
# Load Data
company_db <- readRDS("./wrds_data/company_all.rds")

# Extract relevant company information
compustat_company_data <- company_db %>%
    select(gvkey, conm, dlrsn, dldte) %>%
    filter(dlrsn %in% c("02", "03")) %>%  # Bankruptcy (02) or liquidation (03)
    collect()
```

